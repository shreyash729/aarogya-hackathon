<!DOCTYPE html>
<html lang="en" data-theme="night">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Clinical Notes</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
   <style>
   </style>
</head>
<body class="bg-gray-100 font-sans " >
    
{% block content %}
   <div class="container mx-auto px-4 py-8 max-w-3xl">
        <h2 class="text-3xl font-bold text-gray-800 mb-4">Clinical Notes</h2>
        <p class="text-gray-600 mb-6">Generated by Automated Clinical Documentation System</p>

        <!-- Alert Container -->
        <div id="alert" class="hidden mb-4"></div>

        {% if result and not result.get('error') %}
            <div class="bg-white shadow-md rounded-lg p-6 mb-6">
                <h3 class="text-xl font-semibold text-gray-700 mb-4">Patient Information</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4" id="patientInfo">
                    <div>
                        <label class="text-gray-600 font-medium">Name</label>
                        <p class="text-gray-800" data-field="name">{{ result.get('patient_info', {}).get('name', 'N/A') }}</p>
                        <input type="text" class="hidden w-full border border-gray-300 rounded p-2" value="{{ result.get('patient_info', {}).get('name', '') }}">
                    </div>
                    <div>
                        <label class="text-gray-600 font-medium">Age</label>
                        <p class="text-gray-800" data-field="age">{{ result.get('patient_info', {}).get('age', 'N/A') }}</p>
                        <input type="text" class="hidden w-full border border-gray-300 rounded p-2" value="{{ result.get('patient_info', {}).get('age', '') }}">
                    </div>
                    <div>
                        <label class="text-gray-600 font-medium">Visit Date</label>
                        <p class="text-gray-800" data-field="Dateofvisit">{{ result.get('patient_info', {}).get('Dateofvisit', 'N/A') }}</p>
                        <input type="text" class="hidden w-full border border-gray-300 rounded p-2" value="{{ result.get('patient_info', {}).get('Dateofvisit', '') }}">
                    </div>
                </div>
                <div class="mt-4 flex space-x-2">
                    <button onclick="editPatientInfo()" class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600" id="editPatientBtn">Edit Patient Info</button>
                    <button onclick="savePatientInfo()" class="hidden bg-green-500 text-white px-4 py-2 rounded hover:bg-green-600" id="savePatientBtn">Save Patient Info</button>
                    <button onclick="cancelEdit('patientInfo')" class="hidden bg-gray-500 text-white px-4 py-2 rounded hover:bg-gray-600" id="cancelPatientBtn">Cancel</button>
                </div>
            </div>

            <div class="bg-white shadow-md rounded-lg p-6 mb-6">
                <h3 class="text-xl font-semibold text-gray-700 mb-4">Clinical Notes</h3>
                <div class="space-y-4" id="clinicalNotes">
                    <div>
                        <label class="text-gray-600 font-medium">Chief Complaint</label>
                        <p class="text-gray-800" data-field="ChiefComplaint">{{ result.get('ClinicalNotes', {}).get('ChiefComplaint', 'N/A') }}</p>
                        <textarea class="hidden w-full border border-gray-300 rounded p-2" rows="3">{{ result.get('ClinicalNotes', {}).get('ChiefComplaint', '') }}</textarea>
                    </div>
                    <div>
                        <label class="text-gray-600 font-medium">History of Present Illness</label>
                        <p class="text-gray-800" data-field="HistoryofPresentIllness">{{ result.get('ClinicalNotes', {}).get('HistoryofPresentIllness', 'N/A') }}</p>
                        <textarea class="hidden w-full border border-gray-300 rounded p-2" rows="5">{{ result.get('ClinicalNotes', {}).get('HistoryofPresentIllness', '') }}</textarea>
                    </div>
                    <div>
                        <label class="text-gray-600 font-medium">Diagnosis</label>
                        <p class="text-gray-800" data-field="Diagnosis">{{ result.get('ClinicalNotes', {}).get('Diagnosis', 'N/A') }}</p>
                        <textarea class="hidden w-full border border-gray-300 rounded p-2" rows="3">{{ result.get('ClinicalNotes', {}).get('Diagnosis', '') }}</textarea>
                    </div>
                    <div>
                        <label class="text-gray-600 font-medium">Medicines</label>
                        <div id="medicinesList">
                            {% if result.get('ClinicalNotes', {}).get('Medicines') is iterable and result.get('ClinicalNotes', {}).get('Medicines') != 'value_or_null' %}
                                {% for med in result.get('ClinicalNotes', {}).get('Medicines', []) %}
                                    <div class="medicine-entry mb-2 p-2 border border-gray-200 rounded" data-med-index="{{ loop.index0 }}">
                                        <p class="text-gray-800">
                                            {{ med.get('name', 'N/A') }} ({{ med.get('dosage', 'N/A') }}) - 
                                            {{ med.get('frequency', 'N/A') }} for {{ med.get('duration', 'N/A') }}
                                            {{ ' - ' + med.get('reason', '') if med.get('reason') else '' }}
                                        </p>
                                        <div class="hidden medicine-inputs grid grid-cols-1 md:grid-cols-2 gap-2">
                                            <input type="text" placeholder="Name" class="border border-gray-300 rounded p-2" value="{{ med.get('name', '') }}">
                                            <input type="text" placeholder="Dosage" class="border border-gray-300 rounded p-2" value="{{ med.get('dosage', '') }}">
                                            <input type="text" placeholder="Frequency" class="border border-gray-300 rounded p-2" value="{{ med.get('frequency', '') }}">
                                            <input type="text" placeholder="Duration" class="border border-gray-300 rounded p-2" value="{{ med.get('duration', '') }}">
                                            <input type="text" placeholder="Reason" class="border border-gray-300 rounded p-2" value="{{ med.get('reason', '') }}">
                                        </div>
                                        <button class="remove-medicine hidden text-red-500 hover:text-red-700 text-sm mt-1" data-index="{{ loop.index0 }}">Remove</button>
                                    </div>
                                {% endfor %}
                            {% else %}
                                <p class="text-gray-800" data-field="Medicines">{{ result.get('ClinicalNotes', {}).get('Medicines', 'N/A') }}</p>
                                <textarea class="hidden w-full border border-gray-300 rounded p-2" rows="3">{{ result.get('ClinicalNotes', {}).get('Medicines', '') }}</textarea>
                            {% endif %}
                        </div>
                        <button onclick="addMedicine()" class="hidden text-blue-500 hover:text-blue-700 text-sm mt-2" id="addMedicineBtn">Add Medicine</button>
                    </div>
                </div>
                <div class="mt-4 flex space-x-2">
                    <button onclick="editNotes()" class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600" id="editNotesBtn">Edit Notes</button>
                    <button onclick="saveNotes()" class="hidden bg-green-500 text-white px-4 py-2 rounded hover:bg-green-600" id="saveNotesBtn">Save Notes</button>
                    <button onclick="cancelEdit('clinicalNotes')" class="hidden bg-gray-500 text-white px-4 py-2 rounded hover:bg-gray-600" id="cancelNotesBtn">Cancel</button>
                </div>
            </div>

            <div class="flex flex-wrap gap-2">
                <a href="{{ url_for('notes.notes') }}" class="bg-teal-500 text-white px-4 py-2 rounded hover:bg-teal-600">Test Another Patient</a>
            </div>
        {% elif result.get('error') %}
            <div class="bg-red-100 border-l-4 border-red-500 text-red-700 p-4 mb-4">
                <p>Error: {{ result.get('error') }}</p>
            </div>
        {% else %}
            <div class="bg-yellow-100 border-l-4 border-yellow-500 text-gray-700 p-4 mb-4">
                <p>No medical notes available.</p>
            </div>
        {% endif %}
        <a href="{{ url_for('home') }}" class="mt-4 inline-block text-blue-500 hover:text-blue-700">Home</a>
    </div>

    <script>
        function showAlert(message, type = 'success') {
            const alertDiv = document.getElementById('alert');
            alertDiv.className = `p-4 mb-4 border-l-4 ${type === 'success' ? 'bg-green-100 border-green-500 text-green-700' : 'bg-red-100 border-red-500 text-red-700'}`;
            alertDiv.textContent = message;
            alertDiv.classList.remove('hidden');
            setTimeout(() => alertDiv.classList.add('hidden'), 3000);
        }

        function editPatientInfo() {
            const container = document.getElementById('patientInfo');
            container.querySelectorAll('p').forEach(p => p.classList.add('hidden'));
            container.querySelectorAll('input').forEach(input => input.classList.remove('hidden'));
            document.getElementById('editPatientBtn').classList.add('hidden');
            document.getElementById('savePatientBtn').classList.remove('hidden');
            document.getElementById('cancelPatientBtn').classList.remove('hidden');
        }

        function savePatientInfo() {
            const container = document.getElementById('patientInfo');
            const data = {};
            container.querySelectorAll('input').forEach(input => {
                const field = input.previousElementSibling.dataset.field;
                data[field] = input.value.trim() || null;
            });

            fetch('{{ url_for("notes.save_patient_info") }}', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ patient_info: data })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    container.querySelectorAll('p').forEach(p => {
                        const field = p.dataset.field;
                        p.textContent = data.patient_info[field] || 'N/A';
                        p.classList.remove('hidden');
                        p.nextElementSibling.value = data.patient_info[field] || '';
                    });
                    container.querySelectorAll('input').forEach(input => input.classList.add('hidden'));
                    document.getElementById('editPatientBtn').classList.remove('hidden');
                    document.getElementById('savePatientBtn').classList.add('hidden');
                    document.getElementById('cancelPatientBtn').classList.add('hidden');
                    showAlert('Patient information saved successfully!');
                } else {
                    showAlert(data.error || 'Failed to save patient information.', 'error');
                }
            })
            .catch(error => showAlert('Error saving patient information: ' + error, 'error'));
        }

        function editNotes() {
            const container = document.getElementById('clinicalNotes');
            container.querySelectorAll('p').forEach(p => p.classList.add('hidden'));
            container.querySelectorAll('textarea').forEach(t => t.classList.remove('hidden'));
            container.querySelectorAll('.medicine-entry').forEach(entry => {
                entry.querySelector('p').classList.add('hidden');
                entry.querySelector('.medicine-inputs').classList.remove('hidden');
                entry.querySelector('.remove-medicine').classList.remove('hidden');
            });
            document.getElementById('addMedicineBtn').classList.remove('hidden');
            document.getElementById('editNotesBtn').classList.add('hidden');
            document.getElementById('saveNotesBtn').classList.remove('hidden');
            document.getElementById('cancelNotesBtn').classList.remove('hidden');
        }

        function saveNotes() {
            const container = document.getElementById('clinicalNotes');
            const data = {};
            container.querySelectorAll('textarea').forEach(t => {
                const field = t.previousElementSibling.dataset.field;
                data[field] = t.value.trim() || null;
            });

            const medicines = [];
            container.querySelectorAll('.medicine-entry').forEach(entry => {
                const inputs = entry.querySelector('.medicine-inputs').querySelectorAll('input');
                medicines.push({
                    name: inputs[0].value.trim() || null,
                    dosage: inputs[1].value.trim() || null,
                    frequency: inputs[2].value.trim() || null,
                    duration: inputs[3].value.trim() || null,
                    reason: inputs[4].value.trim() || null
                });
            });
            data.Medicines = medicines.length ? medicines : null;

            fetch('{{ url_for("notes.save_clinical_notes") }}', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ ClinicalNotes: data })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    container.querySelectorAll('p').forEach(p => {
                        const field = p.dataset.field;
                        if (field !== 'Medicines') {
                            p.textContent = data.ClinicalNotes[field] || 'N/A';
                            p.classList.remove('hidden');
                            p.nextElementSibling.value = data.ClinicalNotes[field] || '';
                        }
                    });
                    container.querySelectorAll('textarea').forEach(t => t.classList.add('hidden'));
                    const medicinesList = document.getElementById('medicinesList');
                    medicinesList.innerHTML = data.ClinicalNotes.Medicines && Array.isArray(data.ClinicalNotes.Medicines)
                        ? data.ClinicalNotes.Medicines.map((med, index) => `
                            <div class="medicine-entry mb-2 p-2 border border-gray-200 rounded" data-med-index="${index}">
                                <p class="text-gray-800">
                                    ${med.name || 'N/A'} (${med.dosage || 'N/A'}) - 
                                    ${med.frequency || 'N/A'} for ${med.duration || 'N/A'}
                                    ${med.reason ? ' - ' + med.reason : ''}
                                </p>
                                <div class="hidden medicine-inputs grid grid-cols-1 md:grid-cols-2 gap-2">
                                    <input type="text" placeholder="Name" class="border border-gray-300 rounded p-2" value="${med.name || ''}">
                                    <input type="text" placeholder="Dosage" class="border border-gray-300 rounded p-2" value="${med.dosage || ''}">
                                    <input type="text" placeholder="Frequency" class="border border-gray-300 rounded p-2" value="${med.frequency || ''}">
                                    <input type="text" placeholder="Duration" class="border border-gray-300 rounded p-2" value="${med.duration || ''}">
                                    <input type="text" placeholder="Reason" class="border border-gray-300 rounded p-2" value="${med.reason || ''}">
                                </div>
                                <button class="remove-medicine hidden text-red-500 hover:text-red-700 text-sm mt-1" data-index="${index}">Remove</button>
                            </div>
                        `).join('')
                        : `<p class="text-gray-800" data-field="Medicines">${data.ClinicalNotes.Medicines || 'N/A'}</p>
                           <textarea class="hidden w-full border border-gray-300 rounded p-2" rows="3">${data.ClinicalNotes.Medicines || ''}</textarea>`;
                    container.querySelectorAll('.medicine-entry').forEach(entry => {
                        entry.querySelector('p').classList.remove('hidden');
                        entry.querySelector('.medicine-inputs').classList.add('hidden');
                        entry.querySelector('.remove-medicine').classList.add('hidden');
                    });
                    document.getElementById('addMedicineBtn').classList.add('hidden');
                    document.getElementById('editNotesBtn').classList.remove('hidden');
                    document.getElementById('saveNotesBtn').classList.add('hidden');
                    document.getElementById('cancelNotesBtn').classList.add('hidden');
                    showAlert('Clinical notes saved successfully!');
                } else {
                    showAlert(data.error || 'Failed to save clinical notes.', 'error');
                }
            })
            .catch(error => showAlert('Error saving clinical notes: ' + error, 'error'));
        }

        function cancelEdit(sectionId) {
            const container = document.getElementById(sectionId);
            container.querySelectorAll('p').forEach(p => p.classList.remove('hidden'));
            container.querySelectorAll('input, textarea').forEach(input => input.classList.add('hidden'));
            if (sectionId === 'clinicalNotes') {
                container.querySelectorAll('.medicine-entry').forEach(entry => {
                    entry.querySelector('p').classList.remove('hidden');
                    entry.querySelector('.medicine-inputs').classList.add('hidden');
                    entry.querySelector('.remove-medicine').classList.add('hidden');
                });
                document.getElementById('addMedicineBtn').classList.add('hidden');
                document.getElementById('editNotesBtn').classList.remove('hidden');
                document.getElementById('saveNotesBtn').classList.add('hidden');
                document.getElementById('cancelNotesBtn').classList.add('hidden');
            } else {
                document.getElementById('editPatientBtn').classList.remove('hidden');
                document.getElementById('savePatientBtn').classList.add('hidden');
                document.getElementById('cancelPatientBtn').classList.add('hidden');
            }
        }

        function addMedicine() {
            const medicinesList = document.getElementById('medicinesList');
            const index = medicinesList.querySelectorAll('.medicine-entry').length;
            const newEntry = document.createElement('div');
            newEntry.className = 'medicine-entry mb-2 p-2 border border-gray-200 rounded';
            newEntry.dataset.medIndex = index;
            newEntry.innerHTML = `
                <p class="text-gray-800 hidden">New Medicine</p>
                <div class="medicine-inputs grid grid-cols-1 md:grid-cols-2 gap-2">
                    <input type="text" placeholder="Name" class="border border-gray-300 rounded p-2">
                    <input type="text" placeholder="Dosage" class="border border-gray-300 rounded p-2">
                    <input type="text" placeholder="Frequency" class="border border-gray-300 rounded p-2">
                    <input type="text" placeholder="Duration" class="border border-gray-300 rounded p-2">
                    <input type="text" placeholder="Reason" class="border border-gray-300 rounded p-2">
                </div>
                <button class="remove-medicine text-red-500 hover:text-red-700 text-sm mt-1" data-index="${index}">Remove</button>
            `;
            medicinesList.appendChild(newEntry);
        }

        // Event delegation for remove medicine buttons
        document.getElementById('medicinesList').addEventListener('click', (event) => {
            if (event.target.classList.contains('remove-medicine')) {
                const index = event.target.dataset.index;
                const entry = document.querySelector(`.medicine-entry[data-med-index="${index}"]`);
                if (entry) entry.remove();
            }
        });
    </script>
{% endblock %}
       
          
    
    


   

</body>
</html>


